<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¿†æŸ -moment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            animation: {
              float: 'float 6s ease-in-out infinite',
              breathe: 'breathe 8s ease-in-out infinite',
              'fade-in': 'fadeIn 0.75s ease-out forwards',
            },
            keyframes: {
              float: {
                '0%, 100%': { transform: 'translateY(0)' },
                '50%': { transform: 'translateY(-20px)' },
              },
              breathe: {
                '0%, 100%': { transform: 'scale(1)', opacity: '0.8' },
                '50%': { transform: 'scale(1.5)', opacity: '0.4' },
              },
              fadeIn: {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
            },
          },
        },
      };
    </script>
    <style>
      bo  dy {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #000; /* fallback whileè§†é¢‘æœªåŠ è½½ */
        transition: background-color 0.5s ease;
        min-height: 100vh;
      }
      #bg-video {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -1;
        opacity: 1.0;
        filter: blur(0px);
        pointer-events: none;
      }
      .dark body {
        background-color: #111827;
      }
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #bfbcc6;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #9d98a6;
      }
    </style>
</head>
  <body>
    <video id="bg-video" autoplay muted loop playsinline></video>
    <script>
      (function() {
        const video = document.getElementById('bg-video');
        if (video) {
          video.src = encodeURI('Sleep Better on a Rainy Day ï½œ The Soft Sound of Rain on the Window Makes You Free Your Mind& Relaxâ›ˆï¸libplacebo.mp4');
          video.muted = true;
          video.loop = true;
          video.autoplay = true;
          video.play().catch(() => {
            console.warn('æµè§ˆå™¨é˜»æ­¢äº†è‡ªåŠ¨æ’­æ”¾ï¼Œéœ€ç”¨æˆ·äº¤äº’åæ’­æ”¾èƒŒæ™¯è§†é¢‘');
          });
          video.load();
        }
      })();
    </script>
    <div id="root"></div>
    <script type="text/babel" data-presets="react">
      const {
        useCallback,
        useEffect,
        useMemo,
        useRef,
        useState,
      } = React;

      const AppState = {
        IDLE: 'IDLE',
        SELECT_DURATION: 'SELECT_DURATION',
        BREATHING: 'BREATHING',
        GENERATING: 'GENERATING',
        SHOWING_INSIGHT: 'SHOWING_INSIGHT',
      };

      const mockInsights = [
        {
          haiku: 'é™åå¬é›¨\né£æ‹‚æ¾å½±æ‘‡\nå¿ƒè‡ªå½’ä¸€',
          quote: 'å¿ƒè‹¥å†°æ¸…ï¼Œå¤©å¡Œä¸æƒŠã€‚',
          author: 'å¤è¯­',
          tip: 'é—­ä¸Šçœ¼ç›ï¼Œæ·±å¸ä¸‰å£æ°”ï¼Œæ„Ÿå—ç©ºæ°”ç©¿è¿‡é¼»å°–ã€‚',
        },
        {
          haiku: 'æœˆè½å±±å‰\nå‘¼å¸å¦‚æ½®èµ·\nå¿µéšæ˜Ÿæ²‰',
          quote: 'ä¸‡ç‰©é™è§‚çš†è‡ªå¾—ã€‚',
          author: 'ç¨‹é¢¢',
          tip: 'å°†æ³¨æ„åŠ›æ”¾åœ¨è„šåº•ï¼Œæ„Ÿå—ä¸åœ°é¢çš„è¿æ¥ã€‚',
        },
        {
          haiku: 'æ™¨é›¾æœªæ•£\nå¿ƒå¿µåŒ–æ¸…æ³‰\nè½»èˆŸè‡ªæ¸¡',
          quote: 'å½“ä¸‹å³æ˜¯å”¯ä¸€çš„æ—¶åˆ»ã€‚',
          author: 'ç¦…è¯­',
          tip: 'å†™ä¸‹ä¸€ä»¶è®©ä½ å¿ƒæ€€æ„Ÿæ¿€çš„å°äº‹ã€‚',
        },
      ];

      const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

      const generateInsight = async () => {
        await delay(700);
        return mockInsights[Math.floor(Math.random() * mockInsights.length)];
      };

      class AudioManager {
        constructor() {
          this.audio = null;
          this.fadeFrame = null;
          this.currentVolume = 0;
          this.targetVolume = 1.0;
          this.src = 'BigRicePiano - Waves That Sound Like You.flac';
        }

        ensureAudio() {
          if (!this.audio) {
            const encodedSrc = encodeURI(this.src);
            this.audio = new Audio(encodedSrc);
            this.audio.loop = true;
            this.audio.volume = 0;
            this.audio.preload = 'auto';
          }
          return this.audio;
        }

        toggleBGM(enable) {
          const audio = this.ensureAudio();
          if (!audio) return;

          if (enable) {
            audio
              .play()
              .then(() => this.fadeTo(this.targetVolume))
              .catch(() => {
                console.warn('éœ€è¦ç”¨æˆ·äº¤äº’ä»¥å…è®¸éŸ³é¢‘æ’­æ”¾');
              });
          } else {
            this.fadeTo(0, () => {
              audio.pause();
              audio.currentTime = 0;
            });
          }
        }

        fadeTo(volume, onDone) {
          const audio = this.ensureAudio();
          cancelAnimationFrame(this.fadeFrame);

          const animate = () => {
            const diff = volume - this.currentVolume;
            if (Math.abs(diff) < 0.01) {
              this.currentVolume = volume;
              audio.volume = this.currentVolume;
              if (onDone) onDone();
              return;
            }
            this.currentVolume += diff * 0.15;
            audio.volume = Math.max(0, Math.min(this.currentVolume, 1));
            this.fadeFrame = requestAnimationFrame(animate);
          };

          animate();
        }
      }

      const audioManager = new AudioManager();

      const CALM_BREATHING_STEPS = [
        { label: 'å¸æ°” (Inhale)', duration: 4000, scale: 2.2, opacity: 1 },
        { label: 'å‘¼æ°” (Exhale)', duration: 6000, scale: 1.0, opacity: 0.6 },
      ];

      const MOODS = [
        {
          id: 'calm',
          label: 'å¹³é™ (Calm)',
          icon: 'cloud',
          color: 'bg-teal-100 text-teal-700',
          gradient: 'from-teal-50 to-teal-100',
          tipTextClass: 'text-teal-800 dark:text-teal-100',
          breathingMode: {
            name: 'å…±é¸£å‘¼å¸ (Resonance)',
            description: 'å¹³è¡¡èº«å¿ƒ',
            steps: [
              { label: 'å¸æ°” (Inhale)', duration: 5000, scale: 2.2, opacity: 1 },
              { label: 'å‘¼æ°” (Exhale)', duration: 5000, scale: 1.0, opacity: 0.6 },
            ],
          },
        },
        {
          id: 'anxious',
          label: 'ç„¦è™‘ (Anxious)',
          icon: 'wind',
          color: 'bg-orange-100 text-orange-700',
          gradient: 'from-orange-50 to-orange-100',
          tipTextClass: 'text-orange-900 dark:text-orange-100',
          breathingMode: {
            name: '4-7-8 å‘¼å¸æ³•',
            description: 'ç¼“è§£ç„¦è™‘',
            steps: [
              { label: 'å¸æ°” (Inhale)', duration: 4000, scale: 2.2, opacity: 1 },
              { label: 'å±æ¯ (Hold)', duration: 7000, scale: 2.2, opacity: 1 },
              { label: 'å‘¼æ°” (Exhale)', duration: 8000, scale: 1.0, opacity: 0.6 },
            ],
          },
        },
        {
          id: 'creative',
          label: 'çµæ„Ÿ (Creative)',
          icon: 'zap',
          color: 'bg-purple-100 text-purple-700',
          gradient: 'from-purple-50 to-purple-100',
          tipTextClass: 'text-purple-900 dark:text-purple-100',
          breathingMode: {
            name: 'æµåŠ¨å‘¼å¸ (Flow)',
            description: 'æ¿€æ´»æ€ç»´',
            steps: [
              { label: 'å¸æ°” (Inhale)', duration: 4000, scale: 2.4, opacity: 1 },
              { label: 'å±æ¯ (Hold)', duration: 2000, scale: 2.4, opacity: 1 },
              { label: 'å‘¼æ°” (Exhale)', duration: 4000, scale: 1.0, opacity: 0.6 },
              { label: 'å±æ¯ (Hold)', duration: 1000, scale: 1.0, opacity: 0.6 },
            ],
          },
        },
        {
          id: 'tired',
          label: 'ç–²æƒ« (Tired)',
          icon: 'moon',
          color: 'bg-indigo-100 text-indigo-700',
          gradient: 'from-indigo-50 to-indigo-100',
          tipTextClass: 'text-indigo-900 dark:text-indigo-100',
          breathingMode: {
            name: 'å……èƒ½å‘¼å¸ (Energy)',
            description: 'å”¤é†’èº«ä½“',
            steps: [
              { label: 'å¸æ°” (Inhale)', duration: 6000, scale: 2.5, opacity: 1 },
              { label: 'å±æ¯ (Hold)', duration: 2000, scale: 2.5, opacity: 1 },
              { label: 'å‘¼æ°” (Exhale)', duration: 4000, scale: 1.0, opacity: 0.6 },
            ],
          },
        },
        {
          id: 'stressed',
          label: 'å‹åŠ› (Stressed)',
          icon: 'sun',
          color: 'bg-red-100 text-red-700',
          gradient: 'from-red-50 to-red-100',
          tipTextClass: 'text-red-900 dark:text-red-100',
          breathingMode: {
            name: 'ç®±å¼å‘¼å¸ (Box)',
            description: 'é‡è·æŒæ§',
            steps: [
              { label: 'å¸æ°” (Inhale)', duration: 4000, scale: 2.2, opacity: 1 },
              { label: 'å±æ¯ (Hold)', duration: 4000, scale: 2.2, opacity: 1 },
              { label: 'å‘¼æ°” (Exhale)', duration: 4000, scale: 1.0, opacity: 0.6 },
              { label: 'å±æ¯ (Hold)', duration: 4000, scale: 1.0, opacity: 0.6 },
            ],
          },
        },
        {
          id: 'angry',
          label: 'æ„¤æ€’ (Angry)',
          icon: 'flame',
          color: 'bg-rose-100 text-rose-700',
          gradient: 'from-rose-50 to-rose-100',
          tipTextClass: 'text-rose-900 dark:text-rose-100',
          breathingMode: {
            name: 'é‡Šæ”¾å‘¼å¸ (Release)',
            description: 'å¹³æ¯æ€’ç«',
            steps: [
              { label: 'å¸æ°” (Inhale)', duration: 4000, scale: 2.4, opacity: 1 },
              { label: 'å±æ¯ (Hold)', duration: 2000, scale: 2.4, opacity: 1 },
              { label: 'å‘¼æ°” (Exhale)', duration: 8000, scale: 1.0, opacity: 0.6 },
            ],
          },
        },
      ];

      const Icon = ({ symbol }) => (
        <span className="text-2xl" role="img" aria-hidden="true">
          {symbol}
        </span>
      );

      const IconMap = {
        cloud: <Icon symbol="â˜ï¸" />,
        wind: <Icon symbol="ğŸµ" />,
        zap: <Icon symbol="âš¡" />,
        moon: <Icon symbol="ğŸŒ™" />,
        sun: <Icon symbol="â˜€ï¸" />,
        flame: <Icon symbol="ğŸ”¥" />,
      };

      const MoodGrid = ({ onSelect }) => (
        <div className="w-full max-w-2xl mx-auto p-4">
          <h2 className="text-center text-xl text-gray-500 dark:text-gray-400 mb-8 font-light tracking-wide animate-fade-in">
            æ­¤åˆ»çš„å¿ƒæƒ…å¦‚ä½•ï¼Ÿ<br /><span className="text-sm opacity-60"
              >How are you feeling right now?</span
            >
          </h2>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            {MOODS.map((mood, index) => (
              <button
                key={mood.id}
                onClick={() => onSelect(mood.id)}
                className="group relative overflow-hidden p-6 rounded-2xl transition-all duration-300 hover:shadow-lg hover:-translate-y-1 bg-white border border-gray-100 dark:bg-gray-800 dark:border-gray-700 flex flex-col items-center justify-center gap-3 animate-fade-in"
                style={{ animationDelay: `${index * 100}ms` }}
              >
                <div
                  className={`absolute inset-0 bg-gradient-to-br ${mood.gradient} opacity-0 group-hover:opacity-100 transition-opacity duration-500`}
                ></div>
                <div
                  className={`relative z-10 p-3 rounded-full ${mood.color} bg-opacity-20 dark:bg-opacity-20 dark:bg-gray-700 group-hover:bg-opacity-0 transition-all`}
                >
                  {IconMap[mood.icon]}
                </div>
                <span className="relative z-10 text-gray-700 dark:text-gray-200 font-medium">
                  {mood.label}
                </span>
              </button>
            ))}
          </div>
        </div>
      );

      const PRESETS = [
        { label: '30 ç§’ (30s)', value: 30 * 1000 },
        { label: '1 åˆ†é’Ÿ (1m)', value: 60 * 1000 },
        { label: '3 åˆ†é’Ÿ (3m)', value: 3 * 60 * 1000 },
      ];

      const DurationSelector = ({ onSelect, onBack }) => {
        const [customMinutes, setCustomMinutes] = useState(5);
        return (
          <div className="w-full max-w-2xl mx-auto p-4 animate-fade-in">
            <div className="text-center mb-10 space-y-2">
              <h2 className="text-2xl text-gray-700 dark:text-gray-200 font-light">
                é€‰æ‹©å‘¼å¸æ—¶é•¿
              </h2>
              <p className="text-gray-500 dark:text-gray-400 text-sm">
                Choose your breathing duration
              </p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
              {PRESETS.map((preset) => (
                <button
                  key={preset.value}
                  onClick={() => onSelect(preset.value)}
                  className="group p-6 rounded-2xl bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 hover:shadow-lg hover:-translate-y-1 hover:border-teal-200 dark:hover:border-teal-700 transition-all duration-300 flex flex-col items-center gap-3"
                >
                  <div className="p-3 rounded-full bg-teal-50 text-teal-600 dark:bg-gray-700 dark:text-teal-400 group-hover:bg-teal-100 dark:group-hover:bg-gray-600 transition-colors">
                    <span role="img" aria-label="Preset" className="text-2xl">â³</span>
                  </div>
                  <span className="font-medium text-gray-700 dark:text-gray-200">
                    {preset.label}
                  </span>
                </button>
              ))}
            </div>
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-8 border border-gray-100 dark:border-gray-700 shadow-sm">
              <div className="flex items-center gap-3 mb-6">
                <span className="text-xl text-gray-400" role="img" aria-label="Clock">ğŸ•’</span>
                <h3 className="text-lg font-medium text-gray-700 dark:text-gray-200">
                  è‡ªå®šä¹‰æ—¶é•¿ (Custom)
                </h3>
              </div>
              <div className="space-y-6">
                <div className="flex justify-between items-end">
                  <span className="text-4xl font-light text-teal-600 dark:text-teal-400">
                    {customMinutes}{' '}
                    <span className="text-lg text-gray-500 dark:text-gray-400"
                      >min</span
                    >
                  </span>
                  <span className="text-sm text-gray-400 mb-1">Max 60 min</span>
                </div>
                <input
                  type="range"
                  min="1"
                  max="60"
                  value={customMinutes}
                  onChange={(e) => setCustomMinutes(parseInt(e.target.value, 10))}
                  className="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-teal-600 dark:accent-teal-500"
                />
                <button
                  onClick={() => onSelect(customMinutes * 60 * 1000)}
                  className="w-full py-4 mt-4 bg-gray-900 dark:bg-gray-700 text-white rounded-xl hover:bg-gray-800 dark:hover:bg-gray-600 transition-colors font-medium tracking-wide"
                >
                  å¼€å§‹å‘¼å¸ (Start {customMinutes}m)
                </button>
              </div>
            </div>
            <button
              onClick={onBack}
              className="mt-8 w-full text-center text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 text-sm"
            >
              è¿”å›ä¸Šä¸€æ­¥ (Back)
            </button>
          </div>
        );
      };

      const BreathingCircle = ({
        moodConfig,
        duration,
        onComplete,
        musicEnabled,
      }) => {
        const [phase, setPhase] = useState('COUNTDOWN');
        const [countdown, setCountdown] = useState(3);
        const [timeLeft, setTimeLeft] = useState(duration);
        const [currentStep, setCurrentStep] = useState({
          label: 'å‡†å¤‡ (Ready)',
          duration: 0,
          scale: 1,
          opacity: 1,
        });
        const [instruction, setInstruction] = useState('å‡†å¤‡ (Ready)');

        const stepIndexRef = useRef(0);
        const cycleCountRef = useRef(0);
        const timeoutRef = useRef(null);
        const timerIntervalRef = useRef(null);
        const MIN_MOOD_CYCLES = 2;

        const formatTime = (ms) => {
          const totalSeconds = Math.ceil(ms / 1000);
          const m = Math.floor(totalSeconds / 60);
          const s = totalSeconds % 60;
          return `${m}:${s.toString().padStart(2, '0')}`;
        };

        useEffect(() => {
          if (phase === 'BREATHING') {
            audioManager.toggleBGM(musicEnabled);
          }
          return () => {
            audioManager.toggleBGM(false);
          };
        }, [musicEnabled, phase]);

        useEffect(() => {
          if (phase === 'COUNTDOWN') {
            const countdownInterval = setInterval(() => {
              setCountdown((prev) => {
                if (prev <= 1) {
                  clearInterval(countdownInterval);
                  setPhase('BREATHING');
                  return 0;
                }
                return prev - 1;
              });
            }, 1000);
            return () => clearInterval(countdownInterval);
          }

          if (phase === 'BREATHING') {
            timerIntervalRef.current = setInterval(() => {
              setTimeLeft((prev) => (prev <= 1000 ? 0 : prev - 1000));
            }, 1000);

            const startTime = Date.now();

            const runBreathingLoop = () => {
              const useCalmPattern = cycleCountRef.current >= MIN_MOOD_CYCLES;
              const currentPatternSteps = useCalmPattern
                ? CALM_BREATHING_STEPS
                : moodConfig.breathingMode.steps;
              const step = currentPatternSteps[stepIndexRef.current];

              setCurrentStep(step);
              setInstruction(step.label);

              timeoutRef.current = setTimeout(() => {
                const isEndOfCycle =
                  stepIndexRef.current === currentPatternSteps.length - 1;

                if (isEndOfCycle) {
                  cycleCountRef.current += 1;
                  stepIndexRef.current = 0;
                  const elapsed = Date.now() - startTime;
                  if (elapsed >= duration - 1000) {
                    clearInterval(timerIntervalRef.current);
                    setPhase('DONE');
                    onComplete();
                    return;
                  }
                } else {
                  stepIndexRef.current += 1;
                }

                runBreathingLoop();
              }, step.duration);
            };

            runBreathingLoop();

            return () => {
              if (timeoutRef.current) clearTimeout(timeoutRef.current);
              if (timerIntervalRef.current) clearInterval(timerIntervalRef.current);
            };
          }
        }, [phase, moodConfig, onComplete, duration]);

        const handleFinishEarly = () => {
          if (timeoutRef.current) clearTimeout(timeoutRef.current);
          if (timerIntervalRef.current) clearInterval(timerIntervalRef.current);
          audioManager.toggleBGM(false);
          setPhase('DONE');
          onComplete();
        };

        const colorClass = moodConfig.color.split(' ')[0];
        const accentClass = colorClass.replace(/\d+/, '500');

        if (phase === 'COUNTDOWN') {
          return (
            <div className="flex flex-col items-center justify-center min-h-[50vh] animate-fade-in">
              <div className="text-8xl font-light text-gray-300 dark:text-gray-600 font-mono animate-pulse">
                {countdown}
              </div>
              <p className="mt-8 text-gray-500 dark:text-gray-400 tracking-widest uppercase text-sm">
                Relax & Focus
              </p>
            </div>
          );
        }

        return (
          <div className="flex flex-col items-center justify-center space-y-12 animate-fade-in py-8 relative w-full overflow-hidden">
            <div className="absolute top-0 right-0 md:right-10 flex items-center gap-2 text-gray-400 dark:text-gray-500 font-mono text-sm bg-white/50 dark:bg-black/20 px-3 py-1 rounded-full backdrop-blur-sm z-50">
              <span role="img" aria-label="Timer">â±ï¸</span>
              <span>{formatTime(timeLeft)}</span>
            </div>
            <div className="relative flex items-center justify-center w-[500px] h-[500px]">
              <div
                className={`absolute w-60 h-60 rounded-full opacity-10 dark:opacity-5 ${colorClass} blur-3xl transition-all duration-[3000ms]`}
                style={{ transform: `scale(${currentStep.scale * 1.5})` }}
              ></div>
              <div
                className={`absolute w-60 h-60 rounded-full opacity-30 dark:opacity-20 ${colorClass} blur-2xl`}
                style={{
                  transform: `scale(${currentStep.scale})`,
                  transition: `transform ${currentStep.duration}ms ease-in-out`,
                }}
              ></div>
              <div
                className="relative flex items-center justify-center w-40 h-40 rounded-full shadow-2xl bg-white dark:bg-gray-800 z-10 border-4 border-gray-50 dark:border-gray-700"
                style={{
                  transform: `scale(${currentStep.scale === 1.0 ? 1.0 : 1.15})`,
                  transition: `transform ${currentStep.duration}ms ease-in-out`,
                }}
              >
                <div className={`w-3 h-3 rounded-full ${accentClass} opacity-50`}></div>
              </div>
            </div>
            <div className="text-center space-y-4 h-24 z-20">
              <h3 className="text-3xl md:text-5xl font-light text-gray-700 dark:text-gray-200 tracking-wider transition-all duration-500">
                {instruction}
              </h3>
              <div className="flex flex-col gap-1">
                <p className="text-gray-400 dark:text-gray-500 text-sm font-medium uppercase tracking-widest">
                  {cycleCountRef.current < 2
                    ? moodConfig.breathingMode.name
                    : 'å›å½’å¹³é™ (Calming Down)'}
                </p>
              </div>
            </div>
            <button
              onClick={handleFinishEarly}
              className="mt-12 px-10 py-3 rounded-full bg-white/40 dark:bg-white/10 hover:bg-white/60 dark:hover:bg-white/20 border border-white/50 dark:border-white/10 text-gray-800 dark:text-gray-100 shadow-lg hover:shadow-xl backdrop-blur-md text-sm tracking-[0.2em] uppercase font-semibold transition-all duration-300 z-20"
            >
              ç»“æŸ
            </button>
          </div>
        );
      };

      const InsightCard = ({ data, moodConfig, onReset }) => (
        <div className="w-full max-w-md mx-auto animate-fade-in">
          <div className="bg-white/80 dark:bg-gray-800/90 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden border border-white/50 dark:border-gray-700 transition-colors duration-500">
            <div className={`h-2 bg-gradient-to-r ${moodConfig.gradient}`}></div>
            <div className="p-8 md:p-10 space-y-8">
              <div className="text-center space-y-2">
                <h3 className="text-xs uppercase tracking-[0.2em] text-gray-400 dark:text-gray-500 font-semibold">
                  Haiku
                </h3>
                <div className="text-xl md:text-2xl text-gray-800 dark:text-gray-100 font-serif leading-relaxed italic whitespace-pre-line">
                  {data.haiku}
                </div>
              </div>
              <div className="border-t border-gray-100 dark:border-gray-700 w-1/2 mx-auto"></div>
              <div className="space-y-4">
                <blockquote className="text-lg text-gray-600 dark:text-gray-300 text-center font-light leading-loose">
                  "{data.quote}"
                </blockquote>
                <p className="text-right text-sm text-gray-400 dark:text-gray-500">
                  â€” {data.author}
                </p>
              </div>
              <div
                className={`relative overflow-hidden bg-gradient-to-br ${moodConfig.gradient} dark:bg-none dark:bg-gray-700/30 rounded-xl p-5 transform transition-transform hover:scale-[1.02] border border-transparent dark:border-gray-600`}
              >
                <div className="flex items-center gap-3 mb-2">
                  <div className={`w-2 h-2 rounded-full ${moodConfig.color.split(' ')[0]}`}></div>
                  <h4 className={`text-sm font-semibold uppercase tracking-wider ${moodConfig.tipTextClass}`}>
                    Mindful Action
                  </h4>
                </div>
                <p className={`text-sm leading-relaxed ${moodConfig.tipTextClass}`}>
                  {data.tip}
                </p>
              </div>
            </div>
            <div className="bg-gray-50 dark:bg-gray-900/50 px-8 py-4 flex justify-between items-center border-t border-gray-100 dark:border-gray-700">
              <button
                onClick={onReset}
                className="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"
              >
                <span role="img" aria-label="Reset">ğŸ”„</span>
                <span>é‡æ–°å¼€å§‹</span>
              </button>
              <button
                className="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors opacity-50 cursor-not-allowed"
                title="Sharing coming soon"
              >
                <span role="img" aria-label="Share">ğŸ“¤</span>
                <span>åˆ†äº«</span>
              </button>
            </div>
          </div>
        </div>
      );

      const App = () => {
        const [appState, setAppState] = useState(AppState.IDLE);
        const [selectedMood, setSelectedMood] = useState(null);
        const [selectedDuration, setSelectedDuration] = useState(30000);
        const [insight, setInsight] = useState(null);
        const [darkMode, setDarkMode] = useState(false);
        const [musicEnabled, setMusicEnabled] = useState(false);
        const insightPromise = useRef(null);

        useEffect(() => {
          if (darkMode) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        }, [darkMode]);

        const currentMoodConfig = useMemo(
          () => MOODS.find((m) => m.id === selectedMood) || null,
          [selectedMood]
        );

        const handleMoodSelect = useCallback((mood) => {
          setSelectedMood(mood);
          setAppState(AppState.SELECT_DURATION);
        }, []);

        const handleDurationSelect = useCallback(
          (duration) => {
            setSelectedDuration(duration);
            setAppState(AppState.BREATHING);
            insightPromise.current = generateInsight();
          },
          []
        );

        const handleBreathingComplete = useCallback(async () => {
          if (!selectedMood) return;
          setAppState(AppState.GENERATING);
          try {
            const [data] = await Promise.all([
              insightPromise.current || generateInsight(),
              delay(750),
            ]);
            setInsight(data);
            setAppState(AppState.SHOWING_INSIGHT);
          } catch (error) {
            console.error('Failed to generate insight', error);
            setAppState(AppState.IDLE);
          }
        }, [selectedMood]);

        const handleReset = useCallback(() => {
          setAppState(AppState.IDLE);
          setSelectedMood(null);
          setInsight(null);
          insightPromise.current = null;
          audioManager.toggleBGM(false);
        }, []);

        const toggleMusic = () => {
          const next = !musicEnabled;
          setMusicEnabled(next);
          audioManager.toggleBGM(next);
        };

        const getOverlayClass = () => {
          if (darkMode) {
            return 'bg-gradient-to-br from-black/80 via-gray-900/70 to-black/80';
          }
          if (!currentMoodConfig) {
            return 'bg-gradient-to-br from-white/80 via-white/60 to-white/80';
          }
          return `bg-gradient-to-br ${currentMoodConfig.gradient} opacity-70`;
        };

        return (
          <div className="relative min-h-screen text-gray-800 dark:text-gray-100">
            <div
              className={`absolute inset-0 transition-all duration-700 ease-in-out ${getOverlayClass()} pointer-events-none mix-blend-normal`}
            ></div>
            <div className="relative flex flex-col min-h-screen">
              <header className="sticky top-0 w-full p-6 flex items-center justify-between z-50 backdrop-blur-sm bg-white/30 dark:bg-black/20 transition-all duration-300">
              <button
                onClick={handleReset}
                className="flex items-center gap-2 text-gray-700 dark:text-gray-200 hover:opacity-80 transition-opacity"
              >
                <span className="animate-float text-2xl" role="img" aria-label="Breeze">ğŸ’¨</span>
                <h1 className="text-xl font-semibold tracking-tight hidden sm:block">
                  Mindful Moments
                </h1>
              </button>
              <div className="flex items-center gap-3 bg-white/50 dark:bg-black/30 p-1.5 rounded-full shadow-sm backdrop-blur-md">
                <button
                  onClick={handleReset}
                  className="p-2 rounded-full hover:bg-white dark:hover:bg-gray-700 transition-colors text-gray-600 dark:text-gray-300"
                  title="Return Home"
                >
                  <span role="img" aria-label="Home">ğŸ </span>
                </button>
                <div className="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>
                <button
                  onClick={toggleMusic}
                  className={`p-2 rounded-full hover:bg-white dark:hover:bg-gray-700 transition-colors ${
                    musicEnabled
                      ? 'text-teal-600 dark:text-teal-400'
                      : 'text-gray-400 dark:text-gray-500'
                  }`}
                  title={musicEnabled ? 'Mute Background Music' : 'Enable Background Music'}
                >
                  {musicEnabled ? 'ğŸµ' : 'ğŸ”ˆ'}
                </button>
                <div className="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>
                <button
                  onClick={() => setDarkMode(!darkMode)}
                  className="p-2 rounded-full hover:bg-white dark:hover:bg-gray-700 transition-colors text-gray-600 dark:text-gray-300"
                  title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                >
                  {darkMode ? 'ğŸŒ' : 'ğŸŒœ'}
                </button>
              </div>
            </header>
            <main className="flex-grow flex flex-col items-center justify-center p-4 relative w-full max-w-4xl mx-auto">
              {appState === AppState.IDLE && (
                <div className="w-full flex flex-col items-center">
                  <div className="mb-12 text-center space-y-4 animate-fade-in">
                    <h1 className="text-4xl md:text-5xl font-light text-gray-800 dark:text-white tracking-tight">
                      å¯»æ‰¾ä½ çš„
                      <span className="font-serif italic text-gray-500 dark:text-gray-400">
                        å¿ƒæµ
                      </span>
                    </h1>
                    <p className="text-gray-500 dark:text-gray-400 max-w-md mx-auto leading-relaxed">
                      Find your flow. é€‰æ‹©ä¸€ä¸ªå¿ƒæƒ…ï¼Œå¼€å§‹çŸ­æš‚çš„å‘¼å¸æ—…ç¨‹ä¸ AI æ„Ÿæ‚Ÿã€‚
                    </p>
                  </div>
                  <MoodGrid onSelect={handleMoodSelect} />
                </div>
              )}
              {appState === AppState.SELECT_DURATION && (
                <DurationSelector
                  onSelect={handleDurationSelect}
                  onBack={() => setAppState(AppState.IDLE)}
                />
              )}
              {appState === AppState.BREATHING && currentMoodConfig && (
                <div className="w-full flex flex-col items-center justify-center min-h-[50vh]">
                  <BreathingCircle
                    onComplete={handleBreathingComplete}
                    moodConfig={currentMoodConfig}
                    duration={selectedDuration}
                    musicEnabled={musicEnabled}
                  />
                </div>
              )}
              {appState === AppState.GENERATING && (
                <div className="flex flex-col items-center gap-6 animate-pulse">
                  <div className="text-5xl">âœ¨</div>
                  <p className="text-gray-500 dark:text-gray-400 font-light tracking-widest uppercase text-sm text-center">
                    æ­£åœ¨ç”Ÿæˆæ„Ÿæ‚Ÿ...
                    <br />
                    <span className="text-xs opacity-70">Generating Insight...</span>
                  </p>
                </div>
              )}
              {appState === AppState.SHOWING_INSIGHT && insight && currentMoodConfig && (
                <InsightCard data={insight} moodConfig={currentMoodConfig} onReset={handleReset} />
              )}
            </main>
              <footer className="w-full p-6 text-center text-gray-400 dark:text-gray-600 text-sm font-light">
                <p>Â© {new Date().getFullYear()} ç¥æ„¿èº«ä½“å¥åº·ï¼Œæ­å–œå‘è´¢ï¼Œä¸‡äº‹å¦‚æ„ï¼Œæ­¥æ­¥é«˜å‡ï¼</p>
              </footer>
            </div>
          </div>
        );
      };

      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
</body>
</html>
